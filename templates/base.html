<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Hệ thống Tuyển sinh{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/floating-chat.css') }}">
    <style>
        * { font-family: 'Be Vietnam Pro', sans-serif; }
        
        /* Floating Action Button Styles */
        .fab-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
        }
        
        .fab-main {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .fab-main:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.6);
        }
        
        .fab-menu {
            position: absolute;
            bottom: 80px;
            right: 0;
            display: none;
            flex-direction: column;
            gap: 16px;
        }
        
        .fab-menu.active {
            display: flex;
            animation: fadeInUp 0.3s ease;
        }
        
        .fab-item {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            cursor: pointer;
        }
        
        .fab-label {
            background: white;
            color: #1f2937;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.3s ease;
        }
        
        .fab-menu.active .fab-label {
            opacity: 1;
            transform: translateX(0);
        }
        
        .fab-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .fab-icon:hover {
            transform: scale(1.1);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Scroll to top button */
        .scroll-top {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 48px;
            height: 48px;
            background: #4f46e5;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
            transition: all 0.3s ease;
            z-index: 999;
        }
        
        .scroll-top:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.6);
        }
        
        .scroll-top.visible {
            display: flex;
        }
        
        /* Admin Dropdown Menu */
        .admin-dropdown {
            position: relative;
        }
        
        .admin-dropdown-menu {
            display: none;
            animation: fadeInDown 0.2s ease;
        }
        
        .admin-dropdown:hover .admin-dropdown-menu {
            display: block;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-50">
    <div id="user-flags" data-auth="{{ '1' if current_user.is_authenticated else '0' }}" data-role="{{ current_user.role if current_user.is_authenticated else '' }}" data-verified="{{ '1' if current_user.is_authenticated and current_user.email_verified else '0' }}" style="display:none"></div>

    <!-- Quick Links Navbar -->
    <nav class="bg-white shadow sticky top-0 z-40">
        <div class="container mx-auto px-4 py-2 flex flex-wrap items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="{{ url_for('index') }}" class="text-gray-700 hover:text-indigo-600 font-bold text-lg flex items-center"><i class="fas fa-graduation-cap mr-2"></i>Hệ thống Tuyển sinh</a>
            </div>
            <ul class="flex flex-wrap items-center space-x-4 text-sm font-medium">
                <li><a href="{{ url_for('index') }}" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-home mr-1"></i>Trang chủ</a></li>
                <li><a href="{{ url_for('programs') }}" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-book mr-1"></i>Ngành đào tạo</a></li>
                <li><a href="{{ url_for('advisor_page') }}" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-brain mr-1"></i>Tư vấn AI</a></li>
                <li><a href="{{ url_for('departments') }}" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-building mr-1"></i>Khoa/Viện</a></li>
                <li><a href="{{ url_for('news_list') }}" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-newspaper mr-1"></i>Tin tức</a></li>
                <li><a href="{{ url_for('view_results') }}" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-magnifying-glass mr-1"></i>Kết quả</a></li>
                <li><a href="{{ url_for('contact') }}" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-envelope mr-1"></i>Liên hệ</a></li>
                
                {% if current_user.is_authenticated %}
                    {% if current_user.role == 'admin' %}
                    <!-- Admin Dropdown Menu -->
                    <li class="relative admin-dropdown">
                        <button class="text-white bg-gradient-to-r from-purple-500 to-indigo-600 px-4 py-2 rounded-lg hover:shadow-lg transition-all flex items-center gap-2 font-semibold">
                            <i class="fas fa-user-shield"></i>
                            <span>Quản trị</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div class="admin-dropdown-menu hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                            <div class="px-4 py-3 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-indigo-50">
                                <p class="text-xs text-gray-500">Bảng điều khiển</p>
                                <p class="font-semibold text-gray-800">{{ current_user.email }}</p>
                            </div>
                            <div class="py-2">
                                <a href="{{ url_for('admin_dashboard') }}" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 transition-colors">
                                    <i class="fas fa-tachometer-alt text-indigo-600 w-5"></i>
                                    <span>Dashboard</span>
                                </a>
                                <a href="{{ url_for('admin_applications') }}" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 transition-colors">
                                    <i class="fas fa-file-alt text-blue-600 w-5"></i>
                                    <span>Quản lý hồ sơ</span>
                                </a>
                                <a href="{{ url_for('admin_programs') }}" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 transition-colors">
                                    <i class="fas fa-book text-green-600 w-5"></i>
                                    <span>Quản lý ngành học</span>
                                </a>
                                <a href="{{ url_for('admin_departments') }}" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 transition-colors">
                                    <i class="fas fa-building text-purple-600 w-5"></i>
                                    <span>Quản lý khoa/viện</span>
                                </a>
                                <a href="{{ url_for('admin_statistics') }}" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 transition-colors">
                                    <i class="fas fa-chart-bar text-orange-600 w-5"></i>
                                    <span>Thống kê</span>
                                </a>
                                <a href="{{ url_for('admin_users') }}" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 transition-colors">
                                    <i class="fas fa-users-cog text-red-600 w-5"></i>
                                    <span>Quản lý tài khoản</span>
                                </a>
                                <a href="{{ url_for('admin_contact') }}" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 transition-colors">
                                    <i class="fas fa-cog text-gray-600 w-5"></i>
                                    <span>Cài đặt hệ thống</span>
                                </a>
                                <a href="{{ url_for('admin_export_csv') }}" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-indigo-50 transition-colors">
                                    <i class="fas fa-download text-teal-600 w-5"></i>
                                    <span>Xuất dữ liệu CSV</span>
                                </a>
                            </div>
                        </div>
                    </li>
                    {% else %}
                    <!-- Regular User Menu -->
                    <li><a href="{{ url_for('view_profile') }}" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-user mr-1"></i>Hồ sơ</a></li>
                    <li><a href="{{ url_for('view_wishes') }}" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-heart mr-1"></i>Nguyện vọng</a></li>
                    {% endif %}
                    <li><a href="{{ url_for('logout') }}" class="text-gray-600 hover:text-red-600"><i class="fas fa-sign-out-alt mr-1"></i>Đăng xuất</a></li>
                {% else %}
                    <li><a href="{{ url_for('login') }}" class="text-gray-600 hover:text-indigo-600"><i class="fas fa-sign-in-alt mr-1"></i>Đăng nhập</a></li>
                    <li><a href="{{ url_for('register') }}" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors"><i class="fas fa-user-plus mr-1"></i>Đăng ký</a></li>
                {% endif %}
            </ul>
        </div>
    </nav>
    {% if current_user.is_authenticated %}
    <div class="fixed top-4 right-4 z-50">
        <div class="relative">
            <button id="notificationBtn" 
                    class="w-12 h-12 bg-white rounded-full shadow-lg flex items-center justify-center hover:shadow-xl transition-all hover:scale-110 border-2 border-gray-100">
                <i class="fa-solid fa-bell text-gray-700 text-xl"></i>
                <span id="notificationBadge" 
                      class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center hidden">0</span>
            </button>
            
            <!-- Notification Dropdown -->
            <div id="notificationDropdown" 
                 class="hidden absolute top-14 right-0 w-96 bg-white rounded-xl shadow-2xl border border-gray-200 overflow-hidden">
                <!-- Header -->
                <div class="bg-gradient-to-r from-indigo-500 to-purple-500 p-4 text-white flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-bell"></i>
                        <h3 class="font-bold">Thông báo</h3>
                    </div>
                    <button id="markAllReadBtn" 
                            class="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg transition">
                        Đánh dấu đã đọc
                    </button>
                </div>
                
                <!-- Notification List -->
                <div class="notification-list max-h-96 overflow-y-auto">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                        <p class="text-sm">Đang tải...</p>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="border-t p-3 text-center">
                    <a href="{{ url_for('notifications_page') if url_for is defined else '#' }}" 
                       class="text-sm text-indigo-600 hover:text-indigo-700 font-semibold">
                        Xem tất cả thông báo →
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="fixed top-20 right-4 z-40 space-y-2">
                {% for category, message in messages %}
                <div class="bg-white border-l-4 {% if category == 'success' %}border-green-500{% elif category == 'error' or category == 'danger' %}border-red-500{% elif category == 'warning' %}border-yellow-500{% else %}border-blue-500{% endif %} p-4 rounded shadow-lg max-w-md">
                    <div class="flex items-center">
                        <i class="fas {% if category == 'success' %}fa-check-circle text-green-500{% elif category == 'error' or category == 'danger' %}fa-exclamation-circle text-red-500{% elif category == 'warning' %}fa-exclamation-triangle text-yellow-500{% else %}fa-info-circle text-blue-500{% endif %} mr-3"></i>
                        <span class="text-gray-700">{{ message }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    {% if current_user.is_authenticated and not current_user.email_verified and current_user.role != 'admin' %}
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
        <div class="flex">
            <i class="fas fa-exclamation-triangle text-yellow-400 mr-3 mt-1"></i>
            <div>
                <p class="text-yellow-700"><strong>Chưa xác thực email!</strong> Vui lòng kiểm tra email để xác thực tài khoản. <a href="{{ url_for('resend_verification') }}" class="underline font-semibold">Gửi lại email</a></p>
            </div>
        </div>
    </div>
    {% endif %}
    {% block content %}{% endblock %}
    
    <!-- Floating Action Button (FAB) - Quick Actions -->
    {% if current_user.is_authenticated %}
    <div class="fab-container">
        <div class="fab-menu" id="fabMenu">
            <!-- Chatbot -->
            <div class="fab-item" onclick="window.location.href='{{ url_for('chatbot_page') }}'">
                <span class="fab-label">Tư vấn AI</span>
                <div class="fab-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <i class="fa-solid fa-robot"></i>
                </div>
            </div>
            
            <!-- Profile -->
            <div class="fab-item" onclick="window.location.href='{{ url_for('view_profile') }}'">
                <span class="fab-label">Hồ sơ</span>
                <div class="fab-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                    <i class="fa-solid fa-user"></i>
                </div>
            </div>
            
            <!-- Wishes -->
            <div class="fab-item" onclick="window.location.href='{{ url_for('view_wishes') }}'">
                <span class="fab-label">Nguyện vọng</span>
                <div class="fab-icon" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">
                    <i class="fa-solid fa-heart"></i>
                </div>
            </div>
            
            {% if current_user.role == 'admin' %}
            <!-- Admin Dashboard -->
            <div class="fab-item" onclick="window.location.href='{{ url_for('admin_dashboard') }}'">
                <span class="fab-label">Admin</span>
                <div class="fab-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                    <i class="fa-solid fa-shield-halved"></i>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="fab-main" id="fabMain">
            <i class="fa-solid fa-plus"></i>
        </div>
    </div>
    {% endif %}
    
    <!-- Scroll to Top Button -->
    <div class="scroll-top" id="scrollTop">
        <i class="fa-solid fa-arrow-up"></i>
    </div>
    
    <footer class="bg-gray-800 text-white mt-auto">
        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-lg font-bold mb-4"><i class="fas fa-graduation-cap mr-2"></i>Hệ thống Tuyển sinh</h3>
                    <p class="text-gray-400 text-sm">Nền tảng tuyển sinh hiện đại hỗ trợ bằng AI</p>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">Kết nối</h3>
                    <div class="flex space-x-3">
                        <a href="#" class="w-10 h-10 bg-gray-700 hover:bg-blue-600 rounded-full flex items-center justify-center"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="w-10 h-10 bg-gray-700 hover:bg-red-600 rounded-full flex items-center justify-center"><i class="fab fa-youtube"></i></a>
                        <a href="#" class="w-10 h-10 bg-gray-700 hover:bg-blue-400 rounded-full flex items-center justify-center"><i class="fab fa-twitter"></i></a>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400 text-sm">
                <p>&copy; 2025 Hệ thống Tuyển sinh</p>
            </div>
        </div>
    </footer>
    
    <!-- Notification System Script -->
    {% if current_user.is_authenticated %}
    <script>
        // Pass current user ID to JavaScript (use tojson to avoid syntax issues)
        window.currentUserId = {{ current_user.id | tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
    {% endif %}
    
    {% block extra_js %}{% endblock %}
    <script>
        // Auto-dismiss flash messages after 5 seconds
        setTimeout(function() {
            document.querySelectorAll('.fixed.top-4 > div').forEach(msg => {
                msg.style.transition = 'opacity 0.5s';
                msg.style.opacity = '0';
                setTimeout(() => msg.remove(), 500);
            });
        }, 5000);
        
        // Floating Action Button (FAB) Toggle
        const fabMain = document.getElementById('fabMain');
        const fabMenu = document.getElementById('fabMenu');
        
        if (fabMain && fabMenu) {
            fabMain.addEventListener('click', function() {
                fabMenu.classList.toggle('active');
                const icon = fabMain.querySelector('i');
                if (fabMenu.classList.contains('active')) {
                    icon.classList.remove('fa-plus');
                    icon.classList.add('fa-times');
                } else {
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-plus');
                }
            });
            
            // Close FAB menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.fab-container')) {
                    fabMenu.classList.remove('active');
                    const icon = fabMain.querySelector('i');
                    icon.classList.remove('fa-times');
                    icon.classList.add('fa-plus');
                }
            });
        }
        
        // Scroll to Top Button
        const scrollTop = document.getElementById('scrollTop');
        
        if (scrollTop) {
            window.addEventListener('scroll', function() {
                if (window.pageYOffset > 300) {
                    scrollTop.classList.add('visible');
                } else {
                    scrollTop.classList.remove('visible');
                }
            });
            
            scrollTop.addEventListener('click', function() {
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
        }
    </script>
    
    <!-- Floating Chat Widget -->
    <script src="{{ url_for('static', filename='js/floating-chat.js') }}"></script>
</body>
</html>
