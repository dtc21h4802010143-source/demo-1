{% extends "base.html" %}
{% block title %}Sửa ngành{% endblock %}
{% block content %}
<div class="flex min-h-[70vh] items-center justify-center py-8">
  <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl p-8">
    <div class="flex items-center gap-3 mb-6">
      <i class="fa-solid fa-pen-to-square text-2xl text-yellow-400"></i>
      <h2 class="text-2xl font-bold">Sửa ngành đào tạo</h2>
    </div>
    <form method="POST" class="space-y-5">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Tên ngành</label>
          <input type="text" name="name" value="{{ program.name }}" required class="w-full border rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-emerald-400 outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Mã ngành</label>
          <input type="text" name="code" value="{{ program.code }}" required class="w-full border rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-emerald-400 outline-none">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Khoa/Viện</label>
        <select name="department_id" required class="w-full border rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-emerald-400 outline-none">
          {% for dept in departments %}
            <option value="{{ dept.id }}" {% if dept.id == program.department_id %}selected{% endif %}>{{ dept.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Mô tả</label>
        <textarea name="description" class="w-full border rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-emerald-400 outline-none" rows="3">{{ program.description }}</textarea>
      </div>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Thời gian đào tạo</label>
          <input type="text" name="duration" value="{{ program.duration }}" class="w-full border rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-emerald-400 outline-none">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Học phí</label>
          <input type="number" step="0.01" name="tuition_fee" value="{{ program.tuition_fee }}" class="w-full border rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-emerald-400 outline-none">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Yêu cầu đầu vào</label>
        <textarea name="requirements" class="w-full border rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-emerald-400 outline-none" rows="2">{{ program.requirements }}</textarea>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Cơ hội nghề nghiệp</label>
        <textarea name="career_prospects" class="w-full border rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-emerald-400 outline-none" rows="2">{{ program.career_prospects }}</textarea>
      </div>
      <!-- Auto-save indicator -->
      <div class="flex items-center justify-between mt-4 mb-2">
        <div id="autoSaveIndicator" class="text-sm text-gray-500 flex items-center gap-2">
          <i class="fas fa-save"></i>
          <span id="saveStatus">Tự động lưu nháp</span>
        </div>
        <button type="button" id="clearDraft" class="text-sm text-red-500 hover:text-red-700">
          <i class="fas fa-trash-alt mr-1"></i>Xóa nháp
        </button>
      </div>
      
      <div class="flex gap-3 mt-6">
        <button type="submit" class="px-4 py-2 bg-emerald-500 text-white rounded-lg font-semibold hover:bg-emerald-600 transition flex items-center gap-2"><i class="fa-solid fa-floppy-disk"></i> Lưu</button>
        <a href="{{ url_for('admin_programs') }}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition flex items-center gap-2"><i class="fa-solid fa-xmark"></i> Hủy</a>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.querySelector('form');
  const saveStatus = document.getElementById('saveStatus');
  const clearDraftBtn = document.getElementById('clearDraft');
  const storageKey = 'admin_edit_program_{{ program.id }}_draft';
  let autoSaveTimer = null;

  function loadDraft() {
    try {
      const draft = localStorage.getItem(storageKey);
      if (draft) {
        const data = JSON.parse(draft);
        Object.entries(data).forEach(([name, value]) => {
          const input = form.querySelector(`[name="${name}"]`);
          if (input && value) input.value = value;
        });
        updateStatus('Đã khôi phục nháp', 'success');
      }
    } catch (err) {
      console.error('Load draft error:', err);
    }
  }

  function saveDraft() {
    const formData = new FormData(form);
    const data = {};
    for (let [key, value] of formData.entries()) {
      data[key] = value;
    }
    try {
      localStorage.setItem(storageKey, JSON.stringify(data));
      updateStatus('Đã lưu nháp', 'success');
    } catch (err) {
      updateStatus('Lỗi lưu', 'error');
    }
  }

  function updateStatus(text, type) {
    saveStatus.textContent = text;
    const indicator = saveStatus.parentElement;
    indicator.classList.remove('text-gray-500', 'text-green-600', 'text-red-600');
    if (type === 'success') indicator.classList.add('text-green-600');
    else if (type === 'error') indicator.classList.add('text-red-600');
    else indicator.classList.add('text-gray-500');
    setTimeout(() => {
      saveStatus.textContent = 'Tự động lưu nháp';
      indicator.classList.remove('text-green-600', 'text-red-600');
      indicator.classList.add('text-gray-500');
    }, 2000);
  }

  function scheduleAutoSave() {
    clearTimeout(autoSaveTimer);
    updateStatus('Đang lưu...', 'info');
    autoSaveTimer = setTimeout(saveDraft, 1000);
  }

  clearDraftBtn.addEventListener('click', function() {
    if (confirm('Xóa bản nháp đã lưu?')) {
      localStorage.removeItem(storageKey);
      updateStatus('Đã xóa nháp', 'success');
    }
  });

  form.querySelectorAll('input, textarea, select').forEach(el => {
    el.addEventListener('input', scheduleAutoSave);
    el.addEventListener('change', scheduleAutoSave);
  });

  form.addEventListener('submit', function() {
    localStorage.removeItem(storageKey);
  });

  loadDraft();
});
</script>
{% endblock %}